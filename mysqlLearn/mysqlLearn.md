# 一条 SQL 的执行过程

主要总结系统到底如何和MySQL交互，MySQL在接受到我们发送的 SQL 语句时分别做了哪些事情

## MySQL 驱动

当我们系统在和 MySQL 进行通信的时候，MySQL 驱动在底层帮助我们做了对数据库的连接，才有了后面的交互。
这样的话，在系统和 MySQL 进行交互之前，MySQL 驱动会帮我们建立好连接，然后我们只需要发送 SQL 语句就可以执行 CRUD 了。一次 SQL 请求就会建立一个连接，多个请求就会建立多个连接。
我们系统肯定是存在多个请求同时争抢连接的情况，我们的 web 系统一般都是部署在 tomcat 容器中，而 tomcat 是可以并发处理多个请求，这就会导致多个请求建立多个连接，然后使用完再都去关闭。
许多系统在通过 MySQL 驱动和 MySQL 数据库连接的时候是基于 TCP/IP 协议的，如果每个请求都是新建连接和销毁连接，那这样势必会造成不必要的浪费和性能的下降，也就是说多线程请求的时候频繁的创建和销毁连接显然是不合理的，必然会降低我们系统的性能，但是如果提供一些固定的用来连接的线程，就不需要反复的创建和销毁线程了，也就是下面提到的数据库连接池。

## 数据库连接池

数据库连接池：维护一定的连接数，方便系统获取连接，使用时就去池子中获取，用完放回池子中，我们不需要关心连接的创建与销毁，也不需要关心线程池是怎么维护这些连接。
常见的数据库连接池有Druid、C3PO、DBCP，采用连接池大大节省了不断创建与销毁线程的开销。
系统在访问MySQL数据库的时候，建立的连接并不是每次请求都会去创建的，而是从数据库连接池中去获取，解决了因为反复的创建和销毁连接而带来的性能损耗问题，业务系统都是并发的，MySQL接收请求的线程当然也不只有一个。
其实 MySQL 的架构体系中也已经提供了这样的数据库连接池，双方都是通过数据库连接池来管理各个连接，这样一方面线程之前不需要争抢连接，更重要的是不需要反复的创建和销毁连接。

## 网络连接必须由线程来处理

网络中的连接都是由线程来处理的，所谓网络连接就是一次请求，每次请求都会有相应的线程去处理，也就是说对于 SQL 语句的请求在 MySQL 中是由一个个的线程去处理的。

## SQL 接口

MySQL 中处理请求的线程在获取到请求以后获取 SQL 语句去交给 SQL 接口去处理。

## 查询解析器
```
SELECT stuName,age,sex FROM students WHERE id=1;
```
这个 SQL 是写给我们自己看的，机器并不知道在说什么，这个时候解析器就上场了。它会将 SQL 接口传递过来的 SQL 语句进行解析，翻译成 MySQL 自己能认识的语言。
现在 SQL 已经被解析成 MySQL 认识的样子，下一步 MySQL 会帮我们选择最优的查询路径。
> 最优查询路径：就是 MySQL 会按照自己认为的效率最高的方式进行查询。

## MySQL 查询优化器
MySQL会帮我们去使用他自己认为的最好的方式去优化这条 SQL 语句，并生成一条条的执行计划，比如你创建了多个索引，MySQL 会依据成本最小原则来选择使用对应的索引，这里的成本主要包括两个方面，IO 成本和 CPU 成本。
IO成本：即从磁盘把数据加载到内存的成本。默认情况下，读取数据页的IO成本是1，MySQL以页的形式读取数据，即当用到某个数据时，并不会只读取这个数据，而会把相邻的数据也一起读到内存中，这就是有名的局部性原理，所以 MySQL 每次会读取一整页，一页的成本就是1，所以 IO 的成本主要和页的大小有关。
CPU成本：将数据读入内存后，还要检测数据是否满足条件和排序等 CPU 操作的成本，显然它与行数有关，默认情况下，检测记录的成本是0.2
MySQL 优化器会计算 IO成本+CPU 成本最小的那个索引来执行。
优化器执行选出最优索引等步骤后，会去调用存储引擎接口，开始去执行被 MySQL 解析过和优化过的 SQL 语句。

## 存储引擎
